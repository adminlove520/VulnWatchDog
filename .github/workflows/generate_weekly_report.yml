name: Generate Weekly Vulnerability Report

on:
  schedule:
    # 每周一早上9点生成周报
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # 允许手动触发

jobs:
  generate-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Generate weekly report
        run: python -c "from main import generate_weekly_report; generate_weekly_report()"
      
      - name: Commit and push report
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          
          # 查找最近生成的周报文件
          REPORT_FILE=$(find data/WeeklyReport -name "Weekly_*.md" -type f -mtime -1 | sort | tail -1)
          
          if [ -n "$REPORT_FILE" ]; then
            echo "Found report file: $REPORT_FILE"
            git add "$REPORT_FILE"
            
            # 检查是否有更改
            if git diff --quiet --staged; then
              echo "No changes to commit"
            else
              git commit -m "Add weekly vulnerability report $(date +'%Y-%m-%d')"
              git push
            fi
          else
            echo "No report file found"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}